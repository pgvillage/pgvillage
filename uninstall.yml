---
- name: "deinstallatie van bouwblok" 
  hosts:
    - all
  vars_prompt:
    - name: sure
      prompt: "Dit playbook deinstalleert bouwblok, weet je zeker? Type YES om door te gaan, CTRL+C om af te breken..." 
      private: no
  become: true
  tasks:
    - name: "Are you sure?"
      assert:
        that:
          - "sure == 'YES'"

    - name: stop services
      service:
        name: "{{ item }}" 
        state: stopped
      ignore_errors: true
      loop:
        - pgroute66
        - haproxy 
        - stolon-proxy
        - stolon-sentinel
        - stolon-keeper
        - etcd
        - avchecker

    - name: remove packages
      dnf:
        name:
          - stolon
          - "oracle-instantclient-basic"
          - "oracle-instantclient-devel"
          - "oracle-instantclient-sqlplus"
          - "oracle-instantclient-odbc"
          - "oracle-fdw12"
          - etcd
          - haproxy
          - pgroute66
          - minio
          - wal-g-pg
        state: absent
      ignore_errors: true
      loop:

    - name: remove users
      become: true
      user:
        name: "{{ item.user }}"
        remove: true
        state: absent
      ignore_errors: true
      when: inventory_hostname in groups[ item.environment ]
      loop:
        - { environment: hacluster, user: postgres,etcd,avchecker,pgquartz }
        - { environment: router, user: haproxy,pgroute66 }

    - name: remove etcd data
      become: true
      file:
        path: "{{ etcd_data_dir }}"
        state: absent
      when: inventory_hostname in groups['hacluster']
