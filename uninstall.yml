---
- name: "Run the playbook"
  hosts:
    - all
  vars_prompt:
    - name: sure
      prompt: "This will remove postgres and all backups. Are you really sure? Type 'yes' in uppercase if you are..."
      private: no
  become: true
  tasks:
    - name: "Are you sure?"
      assert:
        that:
          - "sure == 'YES'"
    - name: "Run uninstall"
      become: true
      script: uninstall.sh
    - name: remove packages
      become: true
      yum:
        name: "{{ item }}"
        state: absent
      loop:
      - stolon
      - avchecker
      - pgroute66
      - haproxy
      - "postgresql{{ linux_pg_version|replace('.','') }}"
      - "postgresql{{ linux_pg_version|replace('.','') }}-server"
      - "postgresql{{ linux_pg_version|replace('.','') }}-contrib"
      - "postgresql{{ linux_pg_version|replace('.','') }}-devel"
      - "postgresql{{ linux_pg_version|replace('.','') }}-plpython3"
      - "stolon"
      - "wal-g-pg"
      - "etcd"

    - name: kill processes of users
      become: true
      shell: "killall -KILL -u {{ item }}"
      loop:
      - postgres
      - etcd
      - avchecker
      - pgquartz
      when: inventory_hostname in groups['hacluster']

    - name: remove users
      become: true
      user:
        name: "{{ item }}" 
        remove: true
        state: absent
      loop:
      - postgres
      - etcd
      - avchecker
      - pgquartz
      when: inventory_hostname in groups['hacluster']

    - name: remove dir
      become: true
      file:
        name: "{{ item }}"
        state: absent
      loop: 
      - "{{etcd_data_dir}}"
      when: inventory_hostname in groups['hacluster']

    - name: kill processes of users
      shell: "killall -KILL -u {{ item }}"
      loop:
      - haproxy
      - pgroute66
      when: inventory_hostname in groups['router']

    - name: remove users
      become: true
      user:
        name: "{{ item }}" 
        remove: true
        state: absent
      loop:
      - haproxy
      - pgroute66
      when: inventory_hostname in groups['router']

    - name: remove etcd data
      become: true
      file:
        path: "{{ etcd_data_dir }}" 
        state: absent
