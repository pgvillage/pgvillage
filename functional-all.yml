---
- name: "Gather facts on all servers"
  hosts:
    - hacluster
    - backup
    - router
    - localhost
  become: true
  gather_facts: true

- name: Process all linux requirements
  hosts:
    - hacluster
    - backup
    - router
    - localhost
  become: true
  gather_facts: false
  roles:
    - pgvillage.linux
  tags:
    - packages
    - linux

- name: Install and run chainsmith to generate certificate chains
  hosts:
    - hacluster
    - backup
    - router
    - localhost
  become: true
  gather_facts: false
  roles:
    - pgvillage.chainsmith
  tags:
    - chainsmith
    - certificates
    - certs

- name: Configure firewall as required
  hosts:
    - hacluster
    - backup
    - router
  become: true
  gather_facts: false
  roles:
    - pgvillage.firewall
  tags:
    - firewall
    - firewalld

- name: Setup etcd
  hosts:
    - etcd_master
  become: true
  gather_facts: false
  roles:
    - pgvillage.etcd
  tags:
    - etcd

- name: Setup minio
  hosts:
    - backup
  become: true
  gather_facts: false
  roles:
    - pgvillage.minio
  tags:
    - minio

- name: Setup wal-g
  hosts:
    - hacluster
  become: true
  gather_facts: false
  roles:
    - pgvillage.walg
  tags:
    - walg

- name: Setup Postgres with Stolon
  hosts:
    - hacluster
  become: true
  gather_facts: false
  roles:
    - pgvillage.stolon
  tags:
    - stolon
    - postgres
    - postgresql
    - pg

- name: Setup AVChecker to monitor availability of PostgreSQL
  hosts:
    - hacluster
  become: true
  gather_facts: false
  roles:
    - pgvillage.avchecker
  tags:
    - avchecker
    - availability_checker

- name: Setup a proxy with HAProxy, KeepAlived and PGRoute66
  hosts:
    - router
  become: true
  gather_facts: false
  roles:
    - pgvillage.haproxy
    - pgvillage.keepalived
    - pgvillage.pgroute66
  tags:
    - haproxy
    - router
    - keepalived
    - pgroute66

- name: Setup Nagios NRPE checks
  hosts:
    - haproxy
    - backup
    - hacluster
  become: true
  gather_facts: false
  roles:
    - pgvillage.nagios
  tags:
    - nagios

- name: Setup PGQuartz for scheduling of PostgreSQL jobs
  hosts:
    - hacluster
  become: true
  gather_facts: false
  roles:
    - pgvillage.pgquartz
  tags:
    - pgquartz
