---
- name: Red Hat Satellite configuration
  block:
    - name: Enable the Postgresql RHSM subscriptions
      redhat_subscription:
        activationkey: "{{ linux_rh_subscription.activationkey }}"
        org_id: "{{ linux_rh_subscription.org_id }}"
        pool_ids: "{{ linux_rh_subscription.pool_ids }}"
        state: present

    - name: enable rhel_misc repo
      yum_repository:
        name: "{{ linux_rh_misc_repo.name }}"
        description: "{{ linux_rh_misc_repo.description }}"
        baseurl: "{{ linux_rh_misc_repo.baseurl }}"
        enabled: "{{ linux_rh_misc_repo.enabled }}"
        gpgcheck: "{{ linux_rh_misc_repo.gpgcheck }}"
        gpgkey: "{{ linux_rh_misc_repo.gpgkey }}"
        sslverify: "{{ linux_rh_misc_repo.sslverify }}"
        sslcacert: "{{ linux_rh_misc_repo.sslcacert }}"
        sslclientkey: "{{ linux_rh_misc_repo.sslclientkey }}"
        sslclientcert: "{{ linux_rh_misc_repo.sslclientcert }}"
        priority: "{{ linux_rh_misc_repo.priority }}"
      when: "{{ linux_rh_misc_repo }}"
    - name: autoattach
      shell: "subscription-manager auto-attach"
    - name: attach
      shell: "subscription-manager attach"
  when: "linux_rh_subscription"

- name: Add repository
  ansible.builtin.yum_repository:
    name: "{{ item.key }}"
    description: "{{ item.value.description }}"
    baseurl: "{{ item.value.baseurl }}"
    gpgkey: "{{ item.value.gpgkey }}"
    gpgcheck: "{{ item.value.gpgcheck | default('no') }}"
    file: "{{ item.value.file | default(item.key) }}"
  loop: "{{ linux_public_repos | dict2items }}"

- name: Disable postgresql module
  shell: "dnf module list | grep -q postgres && dnf module disable -y postgresql || echo No postgres module"
  args:
    # Running dnf command instead of asnible dnf module on purpose here
    warn: false

- name: Install packages
  dnf:
    name: "{{ item }}"
    state: present
    update_cache: "true"
    disable_gpg_check: "{{ linux_packages_gpg_check }}"
  loop: "{{ linux_packages|bygroup(group_names) }}"
