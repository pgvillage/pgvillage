---
- name: Enable the Postgresql RHSM subscriptions
  redhat_subscription:
    activationkey: "ORG1"
    org_id: "ORG1"
    pool_ids: "{{packages_rhsm_poolids|bygroup(group_names)}}"
    state: present

- name: enable rhel_misc repo
  yum_repository: 
    name: "{{ rhel_misc_repo.name }}"
    description: "{{ rhel_misc_repo.description }}"
    baseurl: "{{ rhel_misc_repo.baseurl }}"
    enabled: "{{ rhel_misc_repo.enabled }}"
    gpgcheck: "{{ rhel_misc_repo.gpgcheck }}"
    gpgkey: "{{ rhel_misc_repo.gpgkey }}"
    sslverify: "{{ rhel_misc_repo.sslverify }}"
    sslcacert: "{{ rhel_misc_repo.sslcacert }}"
    sslclientkey: "{{ rhel_misc_repo.sslclientkey }}"
    sslclientcert: "{{ rhel_misc_repo.sslclientcert }}"
    priority: "{{ rhel_misc_repo.priority }}"

- name: autoattach
  shell: "subscription-manager auto-attach"

- name: attach
  shell: "subscription-manager attach"

- name: Disable postgresql module
  shell: "dnf module disable -y postgresql"
  args:
    # Running dnf command instead of asnible dnf module on purpose here
    warn: false

- name: Install packages
  dnf:
    name: "{{ linux_packages|bygroup(group_names) }}"
    state: present
    update_cache: "true"
    disable_gpg_check: "{{ linux_packages_gpg_check }}"
