---
# defaults file for stolon
stolon_release: "v0.17.0"
stolon_opt_path: "/opt/stolon"
stolon_release_path: "{{ stolon_opt_path }}/{{ stolon_release }}"
stolon_script_path: "{{ stolon_opt_path }}/scripts"
stolon_binary_owner: root
stolon_user: postgres
stolon_group: postgres
stolon_pkg_arch: amd64
stolon_bin_path: "{{ stolon_release_path }}/stolon-{{ stolon_release }}-linux-{{ stolon_pkg_arch }}/bin"
stolon_release_url: "https://github.com/sorintlab/stolon/releases/download/{{ stolon_release }}/stolon-{{ stolon_release }}-linux-{{ stolon_pkg_arch }}.tar.gz"
# If you add items to stolon_packages, the binaries will not be downloaded, but installed from package instead
stolon_package_names: []

stolon_binaries:
  - stolon-keeper
  - stolonctl
  - stolon-proxy
  - stolon-sentinel
stolon_services:
  - keeper
  - proxy
  - sentinel

stolon_pg_version: 12
stolon_cluster_name: stolon-cluster
stolon_store_backend: etcdv3
stolon_proxy_port: 25432
stolon_data_dir: "/var/lib/pgsql/{{ stolon_pg_version }}/data"
stolon_config_dir: "/var/lib/pgsql/{{ stolon_pg_version }}/config"
stolon_custom_config_file: "{{ stolon_config_dir }}/custom_config.yml"
stolon_wal_dir: "{{ stolon_data_dir }}/postgres/pg_wal"
stolon_pg_su_password: supassword
stolon_pg_repl_username: repluser
stolon_pg_repl_password: replpassword
stolon_pg_listen_address: "{{ ansible_default_ipv4.address }}"
stolon_pg_port: 5432
stolon_pg_bin_path: "/usr/pgsql-{{ stolon_pg_version }}/bin/"
stolon_proxy_listen_address: "{{ ansible_default_ipv4.address }}"
stolon_uid: "{{ inventory_hostname_short | replace('-', '_') }}"

# Used to automatically size min_wal_size
stolon_wal_dir_mp: "/var"

# Used for automatically setting work_mem
# Set to 1 for transactional, and 4-16 for analytical
# Consider the averga amount of operations (merge, sort, group, etc.) per query
stolon_query_complexity: 4

#You can reserve memory not te be used by Postgres
stolon_reserved_memory_mb: 0

stolon_max_connections: 100

# Autoconfig ratios
stolon_shared_buffers_ratio: 0.25
stolon_eff_cache_ratio: 0.75
stolon_min_wal_size_ratio: 0.25
stolon_max_wal_size_ratio: 0.75
stolon_workers_ratio: 1
stolon_parallel_ratio: 1
stolon_gather_ratio: 0.5

# Autoconfig calculations
stolon_share_buffers_mb: "{{ [ ( stolon_available_memory_mb|int * stolon_shared_buffers_ratio) | int, 8] | max }}"
stolon_effective_cache_size_mb: "{{ [ ( stolon_available_memory_mb|int * stolon_eff_cache_ratio) | int, 1] | max }}"
stolon_min_wal_size_mb: "{{ [ ( facter_mountpoints[stolon_wal_dir_mp]['size_bytes']|int * stolon_min_wal_size_ratio / 1048576) | int, 80] | max }}"
stolon_max_wal_size_mb: "{{ [ ( facter_mountpoints[stolon_wal_dir_mp]['size_bytes']|int * stolon_max_wal_size_ratio / 1048576) | int, 1024] | max }}"
stolon_max_worker_processes: "{{ [ansible_processor_vcpus|int * stolon_workers_ratio|int, 2] | max }}"
stolon_max_parallel_workers: "{{ [ansible_processor_vcpus|int * stolon_parallel_ratio|int, 2] | max }}"
stolon_max_parallel_workers_per_gather: "{{ [ansible_processor_vcpus|int * stolon_gather_ratio|int, 1] | max }}"
stolon_work_mem_kb: "{{ [ (1024 * (stolon_available_memory_mb|int - stolon_share_buffers_mb|int) / stolon_max_connections / stolon_query_complexity) | int, 64] | max }}"

# You can easilly set this to another profile if you want to. Or define your own...
stolon_autoconfig: '{{ stolon_autoconfig_default }}'

stolon_pg_parameters: "{{ stolon_autoconfig | combine(stolon_extra_pg_parameters) }}"
stolon_extra_pg_parameters: {}

stolon_pg_hba: []

stolon_custom_config:
  pgParameters: "{{ stolon_pg_parameters }}"
  pgHBA: "{{ stolon_pg_hba }}"
# More info:
# - https://github.com/sorintlab/stolon/blob/master/doc/cluster_spec.md):
# - https://github.com/sorintlab/stolon/blob/master/doc/postgres_parameters.md
# - https://github.com/sorintlab/stolon/blob/master/doc/custom_pg_hba_entries.md

stolon_sysconfig:
  stsentinel:
    cluster_name: "{{ stolon_cluster_name }}"
    store_backend: "{{ stolon_store_backend }}"
  stkeeper:
    cluster_name: "{{ stolon_cluster_name }}"
    store_backend: "{{ stolon_store_backend }}"
    data_dir: "{{ stolon_data_dir }}"
    pgdata_dir: "{{ stolon_data_dir }}/postgres"
    pgwal_dir: "{{ stolon_wal_dir }}"
    pg_su_password: "{{ stolon_pg_su_password }}"
    pg_repl_username: "{{ stolon_pg_repl_username }}"
    pg_repl_password: "{{ stolon_pg_repl_password }}"
    pg_listen_address: "{{ stolon_pg_listen_address }}"
    pg_port: "{{ stolon_pg_port }}"
    pg_bin_path: "{{ stolon_pg_bin_path }}"
    uid: "{{ stolon_uid }}"
  stproxy:
    cluster_name: "{{ stolon_cluster_name }}"
    store_backend: "{{ stolon_store_backend }}"
    port: "{{ stolon_proxy_port }}"
    listen-address: "{{ stolon_proxy_listen_address }}"
