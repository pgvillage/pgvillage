---
# tasks file for stolon
- name: Get semodule list
  command: semodule -l
  register: semodule_list

- include_tasks: "selinux.yml"
  when:
    - "'my-stolon' not in semodule_list.stdout_lines"

- name: Checking for valid certs config
  assert:
    that:
      - "'\n' in stolon_client_cert"
      - "'\n' in stolon_client_chain"
      - "'\n' in stolon_client_key"
      - "'\n' in stolon_server_cert"
      - "'\n' in stolon_server_key"
      - "'\n' in stolon_server_chain"
    fail_msg: "Please run chainsmith to succesfully setup certs"
    success_msg: "Client and server certs seem properly setup"

- getent:
    database: passwd
    key: "{{ stolon_user }}"
    split: ":"

- include_tasks: install_local.yml
  when: stolon_release | length > 0 and install_from_satellite == "false" 

- include_tasks: install_from_satellite.yml
  when: stolon_release | length > 0 and install_from_satellite == "true" 

- include_tasks: configure.yml
- include_tasks: certs.yml
- include_tasks: pglogging.yml
- include_tasks: start.yml

- name: wait for stolon port to be active
  pause:
    seconds: 10

- name: create an nrpe and pgroute66  user in Postgres (hack)
  become_user: "postgres"
  shell: psql -tc "select * from pg_user where usename='{{ item }}'" | grep -q '[a-zA-Z0-9]' || psql -c "create user {{ item }}; alter user {{ item }} superuser;"
  environment:
    PGSERVICE: master
  throttle: 1
  loop:
    - pgroute66
    - nrpe


