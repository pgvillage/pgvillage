---
# tasks file for chainsmith
#- name: path to config file
#  debug:
#    var: items
#  loop:
#    - "{{ chainsmith_internal_clients }}"
#    - "{{ chainsmith_external_clients }}"

- name: Create temporary chainsmith config file
  local_action:
    module: ansible.builtin.tempfile
    state: file
    suffix: chainsmith
  run_once: True
  register: chainsmith_config

- name: debug
  debug:
    var: chainsmith_nodes

- name: create chainsmith_config
  local_action:
    module: copy
    dest: '{{ chainsmith_config.path }}'
    content: '{{ chainsmith_body | to_nice_json }}'
  run_once: True

- name: run chainsmith
  local_action:
    module: shell
    cmd: '{{ chainsmith_cmd }} issue'
  environment:
    CHAINSMITH_CONFIG: '{{ chainsmith_config.path }}'
  register: chainsmith_out
  run_once: True

    #- name: Set chain facts
    #  debug:
    #    chainsmith_results_server_cert: '{{ chainsmith_results.certs.server[ansible_fqdn] }}'
    #    chainsmith_results_server_key: '{{ chainsmith_results.private_keys.server[ansible_fqdn] }}'
    #    chainsmith_results_chain: '{{ chainsmith_results_certs.server.chain }}'
    #    chainsmith_results_client_certs: '{{ chainsmith_results.certs.client }}'
    #    chainsmith_results_client_keys: '{{ chainsmith_results.private_keys.client }}'
    #  vars:
    #    chainsmith_results: '{{ chainsmith_out.stdout | from_yaml}}'

- name: Set chain facts
  set_fact:
    chainsmith_results_server_cert: '{{ chainsmith_results.certs.server[ansible_fqdn] }}'
    chainsmith_results_server_key: '{{ chainsmith_results.private_keys.server[ansible_fqdn] }}'
    chainsmith_results_server_chain: '{{ chainsmith_results.certs.server.chain }}'
    chainsmith_results_client_certs: '{{ chainsmith_results.certs.client }}'
    chainsmith_results_client_chain: '{{ chainsmith_results.certs.client.chain }}'
    chainsmith_results_client_keys: '{{ chainsmith_results.private_keys.client }}'
  vars:
    chainsmith_results: '{{ chainsmith_out.stdout | from_yaml}}'
