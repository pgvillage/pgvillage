# Introduction

De PostgreSQL bouwsteen kan eventueel worden uitgevoerd met een PostgreSQL router.

De router bestaat uit een HA setup van 2 servers met een Virtual IP adres.

Dit Virtual IP adres wordt gemanaged middels keepalived.

# Requirements

Op de PostgreSQL router setup zijn de volgende dingen nodig om KeepaliveD te laten functioneren:

- The binary is rolled out using the (standard) KeepaliveD RPM (from Satellite).
- The keepaliveD configuration can be found in `/etc/keepalived/keepalived.conf` and is deployed and managed via Ansible.
  - The value for `virtual_router_id` should be unique per Keepalived cluster within a segment. This value is pseudo-randomly generated by Ansible.

Het is zeer belangrijk dat de router nodes apart worden gepatcht en dat gecontroleerd wordt dat alles na het patchen van de eerste node weer goed op is gekomen voor node 2 wordt gepatcht.

# Use

KeepAliveD is being balanced in use in this situation.

Dat betekent dat beide instances dezelfde priority hebben en geen fallback wordt geinitieerd als beide instances weer beschikbaar zijn.

Under normal circumstances, both nodes will be available and one of the nodes will have been connected to the VIP (it is undetermined which one).

Which VIP has been connected can be checked using the following command:

\# Node 1

```
me@gurus-dbabh-server1 ~/g/ansible-postgres (tmp)> ssh acme-dvppg1pr-server1.acme.corp.com
```

```markdown
[me@acme-dvppg1pr-server1 ~]$ ip a
```

1: lo: `<LOOPBACK, UP, LOWER_UP> MTU 65536 qdisc noqueue state UNKNOWN group default qlen 1000`
-

```
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
```

inet 127.0.0.1/8 scope host lo

```markdown
valid_lft forever preferred_lft forever
```

```
2: ens192: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
```

```
Link/Ethernet: 00:50:56:9d:54:47  
Broadcast (brd): ff:ff:ff:ff:ff:ff
```

inet 10.0.4.*26/23 brd 10.0.4.455 scope global noprefixroute ens192

valid_lft forever  
preferred_lft forever

```markdown
[me@acme-dvppg1pr-server1 ~]$
logout
```

```markdown
Connection to acme-dvppg1pr-server1.acme.corp.com closed.
```

\# Node 2

```
me@gurus-dbabh-server1 ~/g/ansible-postgres (tmp) > ssh acme-dvppg1pr-server2.acme.corp.com
```

\[me@acme-dvppg1pr-server2 ~\]$ ip a

```
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
```

```
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
```

inet 127.0.0.1/8 scope host lo

```
valid_lft forever preferred_lft forever
```

```
ens192: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
```

```
link/ether 00:50:56:9d:79:5e brd ff:ff:ff:ff:ff:ff
```

inet 10.0.4.*27/23 brd 10.0.4.455 scope global noprefixroute ens192

```
valid_lft forever preferred_lft forever
```

inet 10.0.4.*28/23 scope global secondary ens192

```
valid_lft forever preferred_lft forever
```

In this example, node 2 has the extra VIP connected (2 IP addresses: 10.0.4.*27 and 10.0.4.*28) while node 1 does not (1 IP address: 10.0.4.*26).

# ToDo

KeepaliveD could be provided with a script that checks if HAProxy, PgRoute66, and potentially even PostgreSQL behind HAProxy are accessible.

```markdown
KeepaliveD could be provided with a script that checks if HAProxy, PgRoute66, and potentially even PostgreSQL behind HAProxy are accessible.
```

Daarmee zou de beschikbaarheid wellicht nog verhoogd kunnen worden.

In praktijk is echter nooit een issue opgetreden die hiermee voorkomen zou zijn.

